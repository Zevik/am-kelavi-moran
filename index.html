<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>驻砖 住 专住</title>
  <style>
    body { font-family: sans-serif; direction: rtl; margin: 2em; }
    .card { border: 1px solid #ccc; border-radius: 8px; padding: 1em; margin-bottom: 1em; box-shadow: 1px 1px 5px rgba(0,0,0,0.1); }
    .card h3 { margin: 0 0 0.5em 0; }
    .tags { font-size: 0.9em; color: #555; margin-bottom: 0.5em; }
    .footer { font-size: 0.8em; color: #777; margin-top: 1em; }
    .button { margin-left: 1em; padding: 0.3em 0.6em; cursor: pointer; border: none; border-radius: 4px; background: #2196F3; color: white; }
    .filters, .search { margin-bottom: 1em; }
    select[multiple] { height: 100px; width: 200px; }
    .search input[type="text"] { 
      padding: 8px; 
      font-size: 16px; 
      border: 2px solid #ddd; 
      border-radius: 4px; 
      width: 300px;
      direction: rtl;
    }
    .search input[type="text"]:focus {
      border-color: #2196F3;
      outline: none;
    }
    .search label {
      position: relative;
      display: inline-block;
    }
  </style>
  <script>
    function loadApp() {
      google.script.run
        .withSuccessHandler(data => {
          console.log('Data received:', data);
          if (!data || !Array.isArray(data) || data.length === 0) {
            console.error('Invalid or empty data format received:', data);
            
            // Try to get sheet names for debugging
            google.script.run
              .withSuccessHandler(sheetNames => {
                console.log('Available sheets:', sheetNames);
                alert(`砖:  爪 转 .\n转 : ${sheetNames.join(', ')}\n拽 砖 拽专 "Sheet1"  转.`);
              })
              .withFailureHandler(error => {
                console.error('Error getting sheet names:', error);
                alert('砖: 转 砖转拽  驻专   专拽');
              })
              .getSheetNames();
            return;
          }
          window.fullData = data;
          renderCards(data);
          initAutocomplete();
        })
        .withFailureHandler(error => {
          console.error('Error loading data:', error);
          alert('砖 注转 转: ' + error.message);
        })
        .getData();

      google.script.run
        .withSuccessHandler(renderFilters)
        .withFailureHandler(error => {
          console.error('Error loading filter values:', error);
          console.log('Creating filters manually from loaded data...');
          // Try to create filters from the main data if available
          setTimeout(() => {
            if (window.fullData && Array.isArray(window.fullData)) {
              createFiltersFromData();
            }
          }, 1000);
        })
        .getUniqueValues(['  ', '拽专', '转转 拽专']);
    }

    function createFiltersFromData() {
      if (!window.fullData || !Array.isArray(window.fullData)) return;
      
      const filterMappings = {
        '  ': 1,    // column B (index 1) - 砖  专!
        '拽专': 2,   // column C (index 2) 
        '转转 拽专': 3 // column D (index 3)
      };
      
      Object.keys(filterMappings).forEach(filterName => {
        const columnIndex = filterMappings[filterName];
        const select = document.getElementById('filter_' + filterName);
        if (!select) return;
        
        const uniqueValues = new Set();
        window.fullData.forEach(row => {
          if (row[columnIndex]) {
            const value = row[columnIndex].toString().trim();
            if (value) uniqueValues.add(value);
          }
        });
        
        select.innerHTML = '';
        Array.from(uniqueValues).sort().forEach(val => {
          const option = document.createElement('option');
          option.value = val;
          option.textContent = val;
          select.appendChild(option);
        });
      });
    }

    function renderFilters(values) {
      console.log('renderFilters received:', values);
      
      // Check if values is valid
      if (!values || typeof values !== 'object') {
        console.error('Invalid values received in renderFilters:', values);
        return;
      }
      
      ['  ','拽专','转转 拽专'].forEach(colName => {
        const select = document.getElementById('filter_' + colName);
        if (!select) {
          console.warn('Select element not found for:', colName);
          return;
        }
        
        // Check if the column exists and has data
        if (!values[colName] || !Array.isArray(values[colName])) {
          console.warn('No data found for column:', colName, 'in values:', values);
          return;
        }
        
        // Clear existing options first
        select.innerHTML = '';
        
        values[colName].forEach(val => {
          const option = document.createElement('option');
          option.value = val;
          option.textContent = val;
          select.appendChild(option);
        });
      });
    }

    function renderCards(data) {
      const container = document.getElementById('cards');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2em; color: #666;"> 转 爪</div>';
        return;
      }
      
      data.forEach(row => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${row[2] || ''}</h3>
          <div class="tags">
            <strong> :</strong> ${row[1] || ''} | 
            <strong>拽专:</strong> ${row[2] || ''} | 
            <strong>转转 拽专:</strong> ${row[3] || ''}
          </div>
          <div><strong>专:</strong> ${row[4] || ''}</div>
          <div style="margin-top: 1em;">${row[7] || ''}</div>
          <div class="footer">
            : ${row[0] || ''} | 注: ${row[6] || ''}
          </div>
          <button class="button" onclick="showDetails('${(row[7] || '').replace(/'/g, "\\'")}')">抓 驻专 住驻</button>
          <a href="${row[5] || '#'}" target="_blank" class="button">注 住祝</a>
        `;
        container.appendChild(card);
      });
    }

    function showDetails(details) {
      alert(details);
    }

    function runDebug() {
      console.log('Running debug tests...');
      
      // 拽 专 住住
      google.script.run
        .withSuccessHandler(result => {
          console.log('Connection test result:', result);
          if (result.success) {
            alert(`专 转拽!\n砖 : ${result.name}\n转 : ${result.sheets.join(', ')}`);
            
            // 住 拽专  
            result.sheets.forEach(sheetName => {
              console.log(`Testing sheet: ${sheetName}`);
              google.script.run
                .withSuccessHandler(data => {
                  console.log(`Data from ${sheetName}:`, data);
                  if (data && data.length > 0) {
                    alert(`爪 转 -${sheetName}!\n砖专转: ${data.length}`);
                  }
                })
                .withFailureHandler(error => {
                  console.error(`Error reading ${sheetName}:`, error);
                })
                .getDataFromSheet(sheetName);
            });
          } else {
            alert(`砖转 专: ${result.error}`);
          }
        })
        .withFailureHandler(error => {
          console.error('Connection test failed:', error);
          alert(`拽转 专 砖: ${error.message}`);
        })
        .testConnection();

      // 专抓  驻专
      google.script.run
        .withSuccessHandler(result => {
          console.log('Debug completed - check Apps Script logs');
        })
        .withFailureHandler(error => {
          console.error('Debug failed:', error);
        })
        .debugSpreadsheet();
    }

    function initAutocomplete() {
      if (!Array.isArray(window.fullData)) return;
      
      const searchInput = document.getElementById('search');
      const autocompleteContainer = document.createElement('div');
      autocompleteContainer.id = 'autocomplete-container';
      autocompleteContainer.style.cssText = `
        position: relative;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        display: none;
        z-index: 1000;
      `;
      
      searchInput.parentNode.appendChild(autocompleteContainer);
      
      // Collect all searchable text
      const searchableTexts = new Set();
      window.fullData.forEach(row => {
        [row[7], row[2], row[3]].forEach(cell => {
          if (cell) {
            const words = cell.toString().split(/\s+/);
            words.forEach(word => {
              if (word.length > 2) {
                searchableTexts.add(word);
              }
            });
          }
        });
      });
      
      window.searchSuggestions = Array.from(searchableTexts).sort();
      
      searchInput.addEventListener('input', function(e) {
        const value = e.target.value.trim();
        if (value.length < 2) {
          autocompleteContainer.style.display = 'none';
          return;
        }
        
        const suggestions = window.searchSuggestions.filter(suggestion => 
          suggestion.toLowerCase().includes(value.toLowerCase())
        ).slice(0, 10);
        
        if (suggestions.length === 0) {
          autocompleteContainer.style.display = 'none';
          return;
        }
        
        autocompleteContainer.innerHTML = suggestions.map(suggestion => 
          `<div style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;" 
               onmouseover="this.style.background='#f0f0f0'" 
               onmouseout="this.style.background='white'"
               onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
        ).join('');
        
        autocompleteContainer.style.display = 'block';
      });
      
      // Hide autocomplete when clicking outside
      document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !autocompleteContainer.contains(e.target)) {
          autocompleteContainer.style.display = 'none';
        }
      });
    }
    
    function selectSuggestion(suggestion) {
      document.getElementById('search').value = suggestion;
      document.getElementById('autocomplete-container').style.display = 'none';
      applyFilters();
    }

    function applyFilters() {
      if (!Array.isArray(window.fullData)) return;
      const search = document.getElementById('search').value.trim();
      const bVals = Array.from(document.getElementById('filter_  ')?.selectedOptions || []).map(o => o.value);
      const cVals = Array.from(document.getElementById('filter_拽专')?.selectedOptions || []).map(o => o.value);
      const dVals = Array.from(document.getElementById('filter_转转 拽专')?.selectedOptions || []).map(o => o.value);

      const filtered = window.fullData.filter(row => {
        const searchMatch = [row[7], row[2], row[3]].some(cell => (cell || '').toLowerCase().includes(search.toLowerCase()));
        const bMatch = bVals.length === 0 || bVals.some(v => (row[1] || '').includes(v)); // 注 B - "  "
        const cMatch = cVals.length === 0 || cVals.some(v => (row[2] || '').includes(v)); // 注 C - "拽专"
        const dMatch = dVals.length === 0 || dVals.some(v => (row[3] || '').includes(v)); // 注 D - "转转 拽专"
        return searchMatch && bMatch && cMatch && dMatch;
      });

      renderCards(filtered);
    }

    window.onload = () => loadApp();
  </script>
</head>
<body>
  <div class="search">
    <label>驻砖: <input type="text" id="search" oninput="applyFilters()"></label>
    <button onclick="runDebug()" style="margin-right: 10px; padding: 8px; background: #ff6b35; color: white; border: none; border-radius: 4px;"> 拽 专</button>
  </div>

  <div class="filters">
    <label>住 驻 " ":<br><select id="filter_  " multiple onchange="applyFilters()"></select></label>
    <label>住 驻 "拽专":<br><select id="filter_拽专" multiple onchange="applyFilters()"></select></label>
    <label>住 驻 "转转 拽专":<br><select id="filter_转转 拽专" multiple onchange="applyFilters()"></select></label>
  </div>

  <div id="cards"></div>
</body>
</html>
